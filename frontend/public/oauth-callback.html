<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth Callback - ApeRAG</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background-color: #f5f5f5;
            gap: 16px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1890ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="spinner"></div>
    <div>Processing OAuth login...</div>

    <script>
        async function handleOAuth() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                
                // Check for error parameters first
                const error = urlParams.get('error');
                if (error) {
                    window.location.href = '/web/accounts/signin?error=oauth_failed';
                    return;
                }

                // Get OAuth parameters from URL
                const code = urlParams.get('code');
                const state = urlParams.get('state');

                if (!code || !state) {
                    window.location.href = '/web/accounts/signin?error=oauth_invalid';
                    return;
                }

                // Determine provider from localStorage first, then fallback to referrer detection
                let provider = localStorage.getItem('oauth_provider');
                
                // If no provider in localStorage, try to determine from referrer or state
                if (!provider) {
                    const referrer = document.referrer;
                    
                    // Try to detect provider from referrer URL
                    if (referrer.includes('github.com')) {
                        provider = 'github';
                    } else if (referrer.includes('google.com') || referrer.includes('accounts.google.com')) {
                        provider = 'google';
                    } else {
                        // Default fallback
                        provider = 'github';
                    }
                }
                
                // Clean up the stored provider
                localStorage.removeItem('oauth_provider');

                // Construct the callback URL with all parameters
                const callbackUrl = `/api/v1/auth/${provider}/callback?code=${encodeURIComponent(code)}&state=${encodeURIComponent(state)}`;

                try {
                    // Use fetch with proper error handling for OAuth callback
                    const response = await fetch(callbackUrl, {
                        method: 'GET',
                        credentials: 'include', // Important for cookies
                        redirect: 'manual', // Handle redirects manually
                    });

                    // Check for successful response (2xx) - fastapi-users cookie auth returns 204 No Content
                    if (response.ok) {
                        // For cookie authentication, we expect 204 No Content with Set-Cookie header
                        if (response.status === 204) {
                            // Wait a moment to ensure cookie is properly set before redirecting
                            setTimeout(() => {
                                window.location.href = '/web/';
                            }, 1000);
                            return;
                        }
                        
                        // Handle other successful responses
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            await response.json();
                        }
                        
                        // Authentication successful, redirect to main application
                        window.location.href = '/web/';
                        return;
                    }

                    // Check if it's a redirect response (less likely with cookie auth but handle anyway)
                    if (response.status >= 300 && response.status < 400) {
                        const location = response.headers.get('location');
                        
                        // If there's a redirect location, follow it
                        if (location) {
                            if (location.startsWith('/')) {
                                // Relative redirect - navigate within the app
                                window.location.href = '/web' + location;
                            } else {
                                // Absolute redirect - use window.location
                                window.location.href = location;
                            }
                        } else {
                            // No location header, assume success and redirect to home
                            window.location.href = '/web/';
                        }
                        return;
                    }

                    // Handle error responses
                    console.error('OAuth callback failed with status:', response.status);
                    
                    // Try to get error details from response
                    let errorType = 'oauth_failed';
                    try {
                        const errorData = await response.text();
                        console.error('OAuth callback error details:', errorData);
                        
                        // Check for specific error types based on status code
                        if (response.status === 400) {
                            errorType = 'oauth_invalid';
                        } else if (response.status === 401 || response.status === 403) {
                            errorType = 'oauth_unauthorized';
                        } else if (response.status >= 500) {
                            errorType = 'oauth_server_error';
                        }
                    } catch (parseError) {
                        console.error('Failed to parse error response:', parseError);
                    }
                    
                    window.location.href = `/web/accounts/signin?error=${errorType}`;
                } catch (fetchError) {
                    console.error('OAuth callback fetch error:', fetchError);
                    // Fallback: try direct navigation to the callback URL
                    window.location.href = callbackUrl;
                }
            } catch (error) {
                console.error('OAuth callback general error:', error);
                window.location.href = '/web/accounts/signin?error=oauth_failed';
            }
        }

        // Start OAuth handling when page loads
        handleOAuth();
    </script>
</body>
</html>
